# Skyddad v2 – .cursorrules

## Kontekst & mål

- Detta repo är "Skyddad v2" för retea.se – en säker engångsdelning av hemligheter.
- Stack: Node.js + Express, Handlebars-views, MySQL, i18n (sv/en).
- Följ alltid docs/PLAN.md, docs/SECURITY.md och docs/GDPR.md. Om något krockar vinner dokumentationen.

## Arkitektur & filer

- Behåll den definierade projektstrukturen (src/, views/, services/, middleware/, docs/, etc). Skapa inte nya top-level-mappar utan tydlig motivering.
- Ändra ALDRIG root `.htaccess` eller `/retea/.htaccess`. Lägg bara minimal, isolerad `.htaccess` i projektet vid behov.
- Lägg konfiguration i `config/` och hemligheter i ENV-variabler, aldrig hårdkodat.

## Säkerhet & GDPR

- Alla nya endpoints: validera input, sanera data, undvik SQL injection (parameteriserade queries).
- POST/PUT/DELETE måste ha CSRF-skydd och lämplig rate limiting.
- Loggar får inte innehålla PII. Använd hash/anonymisering av IP/user agent enligt docs/GDPR.md.
- Hemligheter krypteras med AES-256-CBC; PIN lagras med bcrypt. Följ `services/encryption.js`-mönstret.

## i18n & UI

- Allt användargränssnitt ska gå via i18n (`locales/sv.json` och `locales/en.json`), inte hårdkodad text i templates.
- Default-språk är svenska; se till att engelska översättningar finns när du lägger till ny text.
- Följ retea.se:s design: mobil-först, tillgänglig, responsiv layout.

## Admin & API

- Endpoints under `/admin/api/*` får ALDRIG exponeras utan autentisering/auktorisering.
- Återanvänd befintligt admin-/auth-flöde där det är möjligt eller lägg till dedikerad admin-middleware.

## Scriptkörning & timeouts

- **KRITISKT**: Kör ALDRIG SSH, SCP eller andra nätverkskommandon direkt via terminal tools. Detta hänger sig och blockera hela chat-sessionen.
- **För SSH/SCP**: Använd ALLTID wrapper-scripts:
  - SSH: `Scripts/safe-ssh.ps1 "command"`
  - SCP: `Scripts/safe-scp.ps1 -Source "file" -Destination "path"`
  - Dessa scripts har inbyggda timeouts och körs i bakgrunden.
- **För andra kommandon**: Generera scripts (PowerShell `.ps1`, bash `.sh`, etc.) som användaren kan köra själv i sin egen terminal.
- När du genererar scripts (Node, shell, PowerShell, Docker):
  - Inkludera alltid rimlig timeout/avslutshantering i varje kommando.
  - För PowerShell: använd `Start-Job` med `Wait-Job -Timeout` för långvariga kommandon.
  - Undvik långvariga blockande kommandon utan timeout.
  - För Docker: använd i första hand detached (`up -d`) och begräns loggoutput.
- **Undantag**: Endast mycket korta lokala kommandon (t.ex. `ls`, `pwd`, `git status`) får köras direkt, max 2-3 sekunder.

## Testning & kvalitet

- När du ändrar logik: uppdatera eller lägg till Jest-tester (unit) och vid behov Supertest-integrationstester.
- Håll koden enkel och lättläst. Prioritera tydlighet framför “smart” abstraktion.
- Kör lint/formatter innan du föreslår commits. Justera hellre befintlig stil än att införa en ny.

## Git & secrets

- Commita aldrig `.env`, nycklar eller andra secrets. Respektera `.gitignore`.
- Commits ska vara små och tematiska, med tydliga commit-meddelanden som beskriver ändringen.
